name: Claude Documentation Sync

on:
  push:
    branches: [develop, main, master]
    paths:
      - 'app/api/**'
      - 'app/models/**'
      - 'app/schemas/**'
      - 'app/core/langgraph/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync documentation with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are keeping documentation in sync with code changes for PratikoAI backend.

            ## Context
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            - **Commit Message:** ${{ github.event.head_commit.message }}

            ## Analysis Process

            ### 1. Identify Changed Files
            Get the list of changed files in relevant paths:
            ```bash
            git diff --name-only HEAD~1..HEAD -- 'app/api/**' 'app/models/**' 'app/schemas/**' 'app/core/langgraph/**'
            ```

            ### 2. Categorize Changes

            #### API Endpoint Changes
            If files in `app/api/` changed:
            - Read the changed endpoint files
            - Check if API documentation needs updating
            - Look for new routes, changed parameters, or removed endpoints

            #### Model Changes
            If files in `app/models/` changed:
            - Read the changed model files
            - Check DATABASE_ARCHITECTURE.md for consistency
            - Look for new tables, changed columns, or relationships

            #### Schema Changes
            If files in `app/schemas/` changed:
            - Read the changed schema files
            - Ensure API documentation reflects new request/response shapes

            #### LangGraph Changes
            If files in `app/core/langgraph/` changed:
            - Read the changed node files
            - Check RAG architecture docs for consistency
            - Update step documentation if needed

            ### 3. Check Documentation Status
            Review current documentation:
            ```bash
            ls -la docs/
            cat docs/INDEX.md
            ```

            ### 4. Determine Required Updates
            Compare code changes against existing documentation:
            - Are there new endpoints not documented?
            - Have endpoint signatures changed?
            - Are there new models not in schema docs?
            - Has the RAG pipeline changed?

            ### 5. Create Documentation Updates
            If updates are needed:

            a) For minor updates, edit existing docs:
            ```bash
            # Example: Update specific section
            cat docs/DATABASE_ARCHITECTURE.md
            # Then use Edit tool to update
            ```

            b) For significant changes, regenerate doc indexes:
            ```bash
            python scripts/generate_docs_index.py
            ```

            ### 6. Create PR with Changes
            If documentation was updated:
            ```bash
            git config user.name "Claude Code Bot"
            git config user.email "claude-bot@pratikoai.com"
            git checkout -b docs/auto-sync-${{ github.sha }}
            git add docs/
            git commit -m "docs: Auto-sync documentation for ${{ github.sha }}

            Updates documentation to reflect code changes:
            - [List specific updates]

            ðŸ¤– Generated with Claude Code"
            git push origin docs/auto-sync-${{ github.sha }}
            gh pr create --title "ðŸ“š docs: Auto-sync documentation" \
              --body "This PR updates documentation to reflect recent code changes.

            ## Changes
            - [List documentation updates]

            ## Related Commit
            ${{ github.sha }}

            ---
            ðŸ¤– Auto-generated by Claude Code" \
              --base ${{ github.ref_name }}
            ```

            ### 7. No Changes Needed
            If documentation is already up-to-date:
            - Log that no updates were needed
            - Exit successfully

            ## Documentation Standards
            - Keep docs concise and accurate
            - Use consistent formatting
            - Include code examples where helpful
            - Update timestamps when modifying docs
            - Follow existing doc structure

            ## Files to Check
            - `docs/DATABASE_ARCHITECTURE.md` - Database schema
            - `docs/architecture/` - System architecture
            - `docs/getting-started/` - Getting started guides
            - `DOCUMENTATION_INDEX.md` - Master index
          allowed_tools: "Bash,Read,Write,Edit,Glob,Grep"
          timeout_minutes: 15
