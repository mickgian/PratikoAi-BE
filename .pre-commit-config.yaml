# Pre-commit hooks configuration
# Install with: pip install pre-commit && pre-commit install

repos:
  # Check for sensitive data
  - repo: local
    hooks:
      - id: check-sensitive-data
        name: Check for sensitive data
        entry: python scripts/check_sensitive_data.py
        language: system
        pass_filenames: false
        always_run: true

      - id: check-alembic-migrations
        name: Check Alembic migrations are up-to-date
        entry: "bash -c 'alembic check || (echo WARNING - Database migrations pending && exit 1)'"
        language: system
        pass_filenames: false
        always_run: false
        files: ^(alembic/versions/.*\.py|app/models/.*\.py)$

  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-json
      - id: check-merge-conflict
      - id: detect-private-key

  # Python linting & formatting with Ruff (replaces: black, isort, flake8, pylint, pyupgrade)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.4
    hooks:
      # Run Ruff linter (checks for errors, unused imports, code smells)
      # Using --exit-zero to show warnings without blocking commits (gradual adoption)
      - id: ruff
        args: [--fix, --exit-zero]  # Auto-fix and don't block commit
      # Run Ruff formatter (enforces consistent code style)
      - id: ruff-format

  # Type checking with MyPy
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.13.0
    hooks:
      - id: mypy
        args: [--config-file=pyproject.toml]
        additional_dependencies:
          - types-requests
          - types-python-dateutil
        # Allow mypy to fail without blocking commit (for gradual adoption)
        verbose: true
        # Use warn_unused_ignores but don't fail on it
        stages: [pre-commit]

  # Security checks
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: (.*\.(lock|example)$|\.github/workflows/.*\.yml$)

  # Check critical dependencies are present
  - repo: local
    hooks:
      - id: check-critical-dependencies
        name: Check critical dependencies in pyproject.toml
        entry: python scripts/check_critical_deps.py
        language: system
        pass_filenames: false
        files: ^pyproject.toml$
        always_run: false

  # Run critical streaming tests before commit (only when SSE-related files change)
  - repo: local
    hooks:
      - id: streaming-tests
        name: Run streaming protection tests
        entry: bash -c 'source scripts/set_env.sh development && python -m pytest tests/core/test_sse_formatter.py tests/api/test_sse_comment_detection.py tests/api/test_sse_keepalive_timing.py tests/unit/core/test_sse_write_helper.py -v --tb=line -x'
        language: system
        pass_filenames: false
        always_run: false
        files: 'app/(core|api)/.*sse.*\.py|tests/.*sse.*\.py'
        stages: [pre-commit]

  # Run RSS scheduler tests before commit (only when scheduler/RSS-related files change)
  - repo: local
    hooks:
      - id: rss-scheduler-tests
        name: Run RSS scheduler tests
        entry: bash -c 'source scripts/set_env.sh development && python -m pytest tests/test_scheduler_italian_integration.py -v --tb=line -x'
        language: system
        pass_filenames: false
        always_run: false
        files: 'app/.*(scheduler|rss).*\.py|tests/.*scheduler.*\.py'
        stages: [pre-commit]

  # Run all tests with coverage check before push
  # This enforces minimum coverage thresholds (49% lines, lowered to unblock development)
  # Moved to pre-push stage to allow fast commits while maintaining quality before sharing code
  - repo: local
    hooks:
      - id: test-coverage
        name: Run tests with coverage threshold check
        entry: bash -c 'source scripts/set_env.sh development && uv run pytest --cov=app --cov-report=term-missing --cov-fail-under=49 --cov-branch -v --tb=line'
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]

  # Auto-regenerate documentation indexes when markdown files change
  - repo: local
    hooks:
      - id: generate-docs-index
        name: Generate documentation indexes
        entry: python scripts/generate_docs_index.py
        language: system
        files: \.md$
        pass_filenames: false
        stages: [pre-commit]

  # Update roadmap deployment timeline estimates when roadmap changes
  - repo: local
    hooks:
      - id: update-roadmap-timeline
        name: Update roadmap deployment timeline estimates
        entry: python scripts/update_roadmap_timeline.py --notify
        language: system
        files: ^ARCHITECTURE_ROADMAP\.md$
        pass_filenames: false
        stages: [pre-commit]
