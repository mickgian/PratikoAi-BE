name: Claude Documentation Sync

on:
  push:
    branches: [develop, main, master]
    paths:
      - 'src/components/**'
      - 'src/app/**'
      - 'src/lib/**'
      - 'src/contexts/**'

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync documentation with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            You are keeping documentation in sync with code changes for PratikoAI Frontend.

            ## Context
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            - **Commit Message:** ${{ github.event.head_commit.message }}

            ## Analysis Process

            ### 1. Identify Changed Files
            Get the list of changed files in relevant paths:
            ```bash
            git diff --name-only HEAD~1..HEAD -- 'src/components/**' 'src/app/**' 'src/lib/**' 'src/contexts/**'
            ```

            ### 2. Categorize Changes

            #### Component Changes
            If files in `src/components/` changed:
            - Read the changed component files
            - Check if component documentation exists
            - Document new props, behaviors, or patterns

            #### Page Changes
            If files in `src/app/` changed:
            - Read the changed page files
            - Check if route documentation needs updating
            - Document new pages or changed layouts

            #### Hook/Library Changes
            If files in `src/lib/` changed:
            - Read the changed files
            - Update API client documentation
            - Document new hooks or utilities

            #### Context Changes
            If files in `src/contexts/` changed:
            - Read the changed context files
            - Update state management documentation
            - Document new context values or actions

            ### 3. Check Documentation Status
            Review current documentation:
            ```bash
            ls -la docs/
            cat docs/development/DESIGN_SYSTEM.md 2>/dev/null || echo "No design system doc"
            cat docs/development/CHAT_REQUIREMENTS.md 2>/dev/null || echo "No chat requirements"
            ```

            ### 4. Determine Required Updates
            Compare code changes against existing documentation:
            - Are there new components not documented?
            - Have component props changed?
            - Are there new pages or routes?
            - Has the design system evolved?

            ### 5. Create Documentation Updates
            If updates are needed:

            a) For component documentation:
            ```bash
            # Check for JSDoc comments in components
            grep -A 10 "interface.*Props" src/components/**/*.tsx | head -50
            ```

            b) For significant changes, create/update docs

            ### 6. Create PR with Changes
            If documentation was updated:
            ```bash
            git config user.name "Claude Code Bot"
            git config user.email "claude-bot@pratikoai.com"
            git checkout -b docs/auto-sync-${{ github.sha }}
            git add docs/
            git commit -m "docs: Auto-sync documentation for ${{ github.sha }}

            Updates documentation to reflect code changes:
            - [List specific updates]

            ðŸ¤– Generated with Claude Code"
            git push origin docs/auto-sync-${{ github.sha }}
            gh pr create --title "ðŸ“š docs: Auto-sync documentation" \
              --body "This PR updates documentation to reflect recent code changes.

            ## Changes
            - [List documentation updates]

            ## Related Commit
            ${{ github.sha }}

            ---
            ðŸ¤– Auto-generated by Claude Code" \
              --base ${{ github.ref_name }}
            ```

            ### 7. No Changes Needed
            If documentation is already up-to-date:
            - Log that no updates were needed
            - Exit successfully

            ## Documentation Standards
            - Keep docs concise and accurate
            - Use consistent formatting
            - Include code examples for components
            - Document props with TypeScript interfaces
            - Follow existing doc structure
            - All user-facing examples in Italian

            ## Key Documentation Files
            - `docs/development/DESIGN_SYSTEM.md` - Design system and components
            - `docs/development/CHAT_REQUIREMENTS.md` - Chat feature requirements
            - `docs/getting-started/TESTING.md` - Testing guide
            - `CLAUDE.md` - Developer guidelines
          allowed_tools: "Bash,Read,Write,Edit,Glob,Grep"
          timeout_minutes: 15
